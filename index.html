<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Office Check-in/Out</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4d6;
        color: #1f2937;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div
      id="loginPage"
      class="bg-white shadow-xl rounded-2xl w-full max-w-sm p-4 sm:p-8 text-center transition-all duration-300 transform"
    >
      <h1 class="text-3xl font-extrabold text-blue-600 mb-4">Welcome</h1>
      <p class="text-gray-500 mb-6">Please log in to continue.</p>
      <div class="space-y-4">
        <div>
          <label
            for="loginName"
            class="block text-sm font-medium text-gray-700 mb-1 text-left"
            >Your Full Name</label
          >
          <input
            type="text"
            id="loginName"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            placeholder="e.g., Jane Doe"
          />
        </div>
        <div>
          <label
            for="loginRole"
            class="block text-sm font-medium text-gray-700 mb-1 text-left"
            >Your Role</label
          >
          <select
            id="loginRole"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
          >
            <option value="Employee">Employee</option>
            <option value="Intern">Intern</option>
          </select>
        </div>
        <button
          id="loginBtn"
          class="w-full py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition transform hover:scale-105 duration-200 shadow-md"
        >
          Log In
        </button>
      </div>
    </div>

    <div
      id="mainApp"
      class="hidden bg-white shadow-xl rounded-2xl w-full max-w-4xl p-4 sm:p-8 space-y-8 transition-all duration-300 transform scale-0"
    >
      <div class="text-center">
        <h1 class="text-4xl font-extrabold text-blue-600 mb-2">
          Office Check-in
        </h1>
        <p class="text-lg text-gray-500">
          Welcome, <span id="welcomeName" class="font-bold"></span>!
        </p>
        <div class="mt-4 text-sm text-gray-400 font-mono select-all">
          Your User ID:
          <span id="userIdDisplay" class="text-gray-600 font-bold"
            >Loading...</span
          >
        </div>
      </div>

      <!-- Check-in Form -->
      <div
        id="checkInForm"
        class="bg-gray-50 p-6 rounded-xl border border-gray-200"
      >
        <button
          id="checkInBtn"
          class="w-full py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition transform hover:scale-105 duration-200 shadow-md"
        >
          Check In
        </button>
      </div>

      <!-- Checked-out Message -->
      <div
        id="checkOutForm"
        class="hidden text-center bg-green-50 p-6 rounded-xl border border-green-200"
      >
        <p class="text-lg text-green-700 font-semibold mb-4">
          You are currently checked in!
        </p>
        <button
          id="checkOutBtn"
          class="w-full py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition transform hover:scale-105 duration-200 shadow-md"
        >
          Check Out
        </button>
      </div>

      <!-- Real-time Check-in List -->
      <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">
          Who's In Today
        </h2>
        <div id="statusMessage" class="text-center text-gray-400 p-6">
          Loading checked-in users...
        </div>
        <div
          id="inList"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 grid md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"
        >
          <!-- User cards will be dynamically added here -->
        </div>
      </div>

      <!-- History Section -->
      <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">
          Check-in History
        </h2>
        <div id="historyMessage" class="text-center text-gray-400 p-6">
          Loading history...
        </div>
        <div
          id="historyList"
          class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-4"
        >
          <!-- History items will be dynamically added here -->
        </div>
      </div>
    </div>

    <!-- Custom Message Modal -->
    <div
      id="messageModal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50"
    >
      <div class="relative p-8 bg-white w-96 mx-auto rounded-xl shadow-lg">
        <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
        <p id="modalMessage" class="text-gray-700 mb-6"></p>
        <div class="text-right">
          <button
            id="modalCloseBtn"
            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        addDoc,
        updateDoc,
        onSnapshot,
        collection,
        query,
        where,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      let db,
        auth,
        userId,
        appId,
        userCheckInDocId = null;
      let userName, userRole;

      // Custom Message Box Function
      const showMessage = (title, message) => {
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalMessage").innerText = message;
        document.getElementById("messageModal").classList.remove("hidden");
      };

      document.getElementById("modalCloseBtn").onclick = () => {
        document.getElementById("messageModal").classList.add("hidden");
      };

      // --- Firebase Initialization ---
      const firebaseConfig = JSON.parse(
        typeof __firebase_config !== "undefined" ? __firebase_config : "{}"
      );
      appId = typeof __app_id !== "undefined" ? __app_id : "default-app-id";

      if (Object.keys(firebaseConfig).length > 0) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        console.log("Firebase initialized");

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            document.getElementById("userIdDisplay").innerText = userId;
            console.log("Authenticated with user ID:", userId);
            // No automatic listener setup, wait for login
          } else {
            console.log("No user signed in. Attempting sign-in...");
            try {
              if (typeof __initial_auth_token !== "undefined") {
                await signInWithCustomToken(auth, __initial_auth_token);
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("Authentication failed:", error);
              showMessage(
                "Error",
                "Authentication failed. Please refresh the page."
              );
            }
          }
        });
      } else {
        showMessage(
          "Error",
          "Firebase configuration not found. Please provide firebase config."
        );
        console.error("Firebase configuration not found.");
      }

      // --- Page Transition Logic ---
      const showMainApp = () => {
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("loginPage").classList.remove("flex");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("mainApp").classList.remove("scale-0");
      };

      // --- Real-time data listeners ---
      const setupRealtimeListeners = () => {
        if (!db || !userId) {
          console.log(
            "Database or user ID not ready. Skipping listener setup."
          );
          return;
        }

        const checkinsCollection = collection(
          db,
          `artifacts/${appId}/public/data/officeCheckins`
        );
        const qActive = query(
          checkinsCollection,
          where("checkOutTime", "==", null)
        );

        const statusMessage = document.getElementById("statusMessage");

        onSnapshot(
          qActive,
          (snapshot) => {
            const inList = document.getElementById("inList");
            inList.innerHTML = "";

            const checkedInUsers = [];
            let isUserCheckedIn = false;
            snapshot.forEach((doc) => {
              const data = doc.data();
              if (data.userId === userId) {
                isUserCheckedIn = true;
                userCheckInDocId = doc.id;
              }
              checkedInUsers.push(data);
            });

            if (isUserCheckedIn) {
              document.getElementById("checkInForm").classList.add("hidden");
              document
                .getElementById("checkOutForm")
                .classList.remove("hidden");
            } else {
              document.getElementById("checkInForm").classList.remove("hidden");
              document.getElementById("checkOutForm").classList.add("hidden");
              userCheckInDocId = null;
            }

            if (checkedInUsers.length === 0) {
              statusMessage.textContent = `Nobody is checked in yet. Be the first!`;
              statusMessage.classList.remove("hidden");
            } else {
              statusMessage.classList.add("hidden");
              checkedInUsers.forEach((user) => {
                const checkInCard = document.createElement("div");
                checkInCard.className = "bg-white p-4 rounded-lg shadow-md";
                const checkInTimeText = user.checkInTime
                  ? new Date(
                      user.checkInTime.seconds * 1000
                    ).toLocaleTimeString()
                  : "Pending...";
                checkInCard.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-100 text-blue-600 font-bold w-10 h-10 flex items-center justify-center rounded-full text-xl">
                                    ${user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${
                                      user.name
                                    }</h3>
                                    <p class="text-sm text-gray-500">${
                                      user.role
                                    }</p>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-400">
                                Checked In: ${checkInTimeText}
                            </div>
                        `;
                inList.appendChild(checkInCard);
              });
            }
          },
          (error) => {
            console.error("Error fetching active users:", error);
            showMessage(
              "Error",
              "Failed to load checked-in users. Please check your internet connection."
            );
            statusMessage.textContent = "Failed to load users.";
            statusMessage.classList.remove("hidden");
          }
        );

        // Listener for all history
        const qHistory = query(checkinsCollection);
        const historyMessage = document.getElementById("historyMessage");

        onSnapshot(
          qHistory,
          (snapshot) => {
            const historyList = document.getElementById("historyList");
            historyList.innerHTML = "";

            let historyRecords = [];
            snapshot.forEach((doc) => {
              historyRecords.push(doc.data());
            });

            // Sort the history by check-in time, handling potential null timestamps
            historyRecords.sort((a, b) => {
              const timeA = a.checkInTime?.seconds || 0;
              const timeB = b.checkInTime?.seconds || 0;
              return timeB - timeA;
            });

            if (historyRecords.length === 0) {
              historyMessage.textContent = "No history available.";
              historyMessage.classList.remove("hidden");
            } else {
              historyMessage.classList.add("hidden");
              historyRecords.forEach((record) => {
                const historyCard = document.createElement("div");
                historyCard.className =
                  "p-4 border border-gray-200 rounded-lg bg-gray-100";
                const checkInTime = record.checkInTime
                  ? new Date(record.checkInTime.seconds * 1000).toLocaleString()
                  : "Pending...";
                let checkOutTime = "N/A";
                if (record.checkOutTime) {
                  checkOutTime = new Date(
                    record.checkOutTime.seconds * 1000
                  ).toLocaleString();
                }
                historyCard.innerHTML = `
                            <p class="font-semibold text-gray-800">${record.name} (${record.role})</p>
                            <p class="text-sm text-gray-500">Checked In: ${checkInTime}</p>
                            <p class="text-sm text-gray-500">Checked Out: ${checkOutTime}</p>
                        `;
                historyList.appendChild(historyCard);
              });
            }
          },
          (error) => {
            console.error("Error fetching history:", error);
            showMessage(
              "Error",
              "Failed to load history. Please check your internet connection."
            );
            historyMessage.textContent = "Failed to load history.";
            historyMessage.classList.remove("hidden");
          }
        );
      };

      // --- Event Handlers ---
      document.getElementById("loginBtn").addEventListener("click", () => {
        const loginName = document.getElementById("loginName").value.trim();
        const loginRole = document.getElementById("loginRole").value;

        if (!loginName) {
          showMessage(
            "Missing Information",
            "Please enter your name to log in."
          );
          return;
        }

        userName = loginName;
        userRole = loginRole;
        document.getElementById("welcomeName").innerText = userName;

        showMainApp();
        setupRealtimeListeners();
      });

      document
        .getElementById("checkInBtn")
        .addEventListener("click", async () => {
          if (!userId) {
            showMessage(
              "Error",
              "Authentication not ready. Please wait a moment and try again."
            );
            return;
          }

          try {
            const docRef = await addDoc(
              collection(db, `artifacts/${appId}/public/data/officeCheckins`),
              {
                userId: userId,
                name: userName,
                role: userRole,
                checkInTime: serverTimestamp(),
                checkOutTime: null,
              }
            );
            console.log("Document written with ID: ", docRef.id);
            showMessage("Success!", "Check In Done.");
          } catch (e) {
            console.error("Error adding document: ", e);
            showMessage("Error", "Failed to check in. Please try again.");
          }
        });

      document
        .getElementById("checkOutBtn")
        .addEventListener("click", async () => {
          if (!userCheckInDocId) {
            showMessage(
              "Error",
              "You are not currently checked in or there was an issue finding your session."
            );
            return;
          }

          try {
            const docRef = doc(
              db,
              `artifacts/${appId}/public/data/officeCheckins`,
              userCheckInDocId
            );
            await updateDoc(docRef, {
              checkOutTime: serverTimestamp(),
            });
            console.log("Document successfully updated for check-out!");
            showMessage(
              "Success!",
              "You have been successfully checked out. Have a great day!"
            );
          } catch (e) {
            console.error("Error updating document: ", e);
            showMessage("Error", "Failed to check out. Please try again.");
          }
        });
    </script>
  </body>
</html>
